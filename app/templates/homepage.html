<!-- homepage.html -->

{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Banner with Avatar and Username -->
    <div class="banner">
        <img src="{{ url_for('static', filename='images/banner.png') }}" alt="Banner" class="banner-img">
        <div class="avatar-wrapper">
            <img src="{{ url_for('static', filename=user.avatar or 'images/avatars/default_avatar.png') }}" alt="User Avatar" class="avatar-img" id="avatar-img">
            <form id="upload-avatar-form" method="POST" enctype="multipart/form-data" action="{{ url_for('routes.upload_avatar') }}">
                {{ form.hidden_tag() }}
                <input type="file" id="avatar-input" name="avatar" style="display: none;" accept="image/*">
            </form>
        </div>
        <div class="username">{{ user.username }}</div> <!-- Display the username next to the avatar -->
    </div>

    <div class="user-info">
        <h1>Welcome, {{ user.username }}!</h1>
        <p>Customise your profile and see your activities here.</p>
        <button class="btn btn-danger" onclick="removeAvatar()">Remove Avatar</button>
    </div>

    <!-- Insights and Posts Section -->
    <div class="content-area">
        <div class="insights-posts-container">
            <!-- Insights Box -->
            <div class="insights-box">
                <h2>My Insights</h2>
                <p>Date Joined: <span class="date-joined">{{ user.created_at.strftime('%Y-%m-%d') }}</span></p>
                <p>Leaderboard Position: <span class="leaderboard-pos">#1</span></p>
            </div>

            <!-- Posts Box -->
            <div class="posts-box">
                <h2>My Posts</h2>
                <div id="user-posts">
                    {% if user_posts %}
                        {% for post in user_posts %}
                            <div class="post">
                                <p>{{ post.content }}</p>
                                <small>Posted on {{ post.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p>You have not made any posts yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('avatar-img').addEventListener('click', function() {
        document.getElementById('avatar-input').click();
    });

    document.getElementById('avatar-input').addEventListener('change', function() {
        document.getElementById('upload-avatar-form').submit();
    });

    function removeAvatar() {
        fetch("{{ url_for('routes.remove_avatar') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': "{{ form.csrf_token._value() }}"
            }
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert('Avatar removed successfully');
                  window.location.reload();
              } else {
                  alert('Failed to remove avatar');
              }
          }).catch(error => {
              console.error('Error removing avatar:', error);
              alert('Error removing avatar.');
          });
    }
</script>
{% endblock %}
